<main id="produtos-page">
    <h1>Nossos Produtos</h1>
    
    <div style="display:flex; justify-content:flex-end; margin-top:10px;">
      <button id="add-product-btn" class="btn-add" onclick="openNewProductModal()" style="display:none;">+ Adicionar Produto</button>
    </div>

    <div id="product-grid" class="product-grid">
      <div style="text-align: center; padding: 40px; color: #999;">Carregando produtos...</div>
    </div>

    <!-- Modal para editar produto -->
    <div id="edit-product-modal" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Editar Produto</h2>
        <form onsubmit="saveProductEdit(event)">
          <div class="form-group">
            <label>Nome *</label>
            <input type="text" id="edit-prod-name" required>
          </div>
          <div class="form-group">
            <label>Descri√ß√£o</label>
            <textarea id="edit-prod-desc" style="width: 100%; min-height: 80px;"></textarea>
          </div>
          <div class="form-group">
            <label>Pre√ßo (R$) *</label>
            <input type="number" id="edit-prod-price" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Imagem *</label>
            <select id="edit-prod-image" required>
              <option value="">Selecione...</option>
              <option value="oval.jpg">Oval</option>
              <option value="quadrado.jpg">Quadrado</option>
              <option value="urso.jpg">Urso</option>
              <option value="oval-desenho.jpg">Oval Desenho</option>
              <option value="quadradinho-desenho.jpg">Quadradinho</option>
              <option value="flor-pequena.jpg">Flor</option>
            </select>
          </div>
          <div style="display: flex; gap: 10px;">
            <button type="submit" style="flex: 1; background: #44b475; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer;">Salvar</button>
            <button type="button" style="flex: 1; background: #999; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer;" onclick="closeEditModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <style>
      /* Estilo do bot√£o de adicionar na p√°gina p√∫blica */
      .btn-add {
        background: #7e69a0; /* lil√°s */
        color: white;
        padding: 10px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 700;
      }

      .btn-add:hover { background: #6a5a89; }

      #product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .product-card {
        background: #f5f0fb;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        text-align: center;
        position: relative;
      }

      .product-card img {
        width: 100%;
        height: 150px;
        object-fit: contain;
        margin-bottom: 10px;
      }

      .card-info h3 {
        color: #403144;
        margin: 10px 0;
      }

      .price {
        color: #44b475;
        font-weight: 600;
        font-size: 18px;
        margin: 10px 0;
      }

      .btn-detalhes {
        display: inline-block;
        background: #7e69a0;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        margin-right: 5px;
        transition: all 0.3s;
      }

      .btn-detalhes:hover {
        background: #6a5a89;
      }

      .btn-edit {
        display: inline-block;
        background: #2196f3;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s;
      }

      .btn-edit:hover {
        background: #1976d2;
      }

      .btn-delete {
        display: inline-block;
        background: #f44336;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s;
      }

      .btn-delete:hover {
        background: #d32f2f;
      }

      .product-actions {
        margin-top: 10px;
        display: flex;
        gap: 5px;
        justify-content: center;
      }

      #edit-product-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      #edit-product-modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #403144;
        font-weight: 600;
      }

      .form-group input, .form-group textarea, .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
      }

      .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
        outline: none;
        border-color: #7e69a0;
        box-shadow: 0 0 3px rgba(126, 105, 160, 0.3);
      }

      .close {
        float: right;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .close:hover {
        color: #333;
      }
    </style>

    <script>
      let editingProductId = null;
      let allProducts = [];
      let isAdmin = false;

      async function loadProducts() {
        const supabase = ensureSupabase();
        if (!supabase) {
          document.getElementById('product-grid').innerHTML = '<p>Erro ao conectar com o banco de dados</p>';
          return;
        }

        // Verificar se o usu√°rio autenticado √© admin
        try {
          const { data: userData } = await supabase.auth.getUser();
          const user = userData?.user || null;
          if (user && user.id) {
            const { data: usuario } = await supabase.from('usuarios').select('role').eq('id', user.id).single();
            if (usuario && usuario.role === 'admin') {
              isAdmin = true;
              const addBtn = document.getElementById('add-product-btn');
              if (addBtn) addBtn.style.display = 'inline-block';
            }
          }
        } catch (e) {
          console.warn('N√£o foi poss√≠vel determinar role do usu√°rio:', e);
        }

        try {
          const { data, error } = await supabase
            .from('products')
            .select('id, name, description, price, image')
            .order('id', { ascending: false });

          if (error) throw error;

          allProducts = data || [];
          renderProducts();
        } catch (err) {
          console.error('Erro ao carregar produtos:', err);
          document.getElementById('product-grid').innerHTML = '<p>Erro ao carregar produtos</p>';
        }
      }

      function renderProducts() {
        const grid = document.getElementById('product-grid');

        if (!allProducts || allProducts.length === 0) {
          grid.innerHTML = '<p>Nenhum produto cadastrado no momento.</p>';
          return;
        }

        grid.innerHTML = allProducts.map(p => `
          <div class="product-card">
            <img src="/img/${p.image}" alt="${p.name}" onerror="this.src='/img/quadrado.jpg'">
            <div class="card-info">
              <h3>${p.name}</h3>
              <p class="price">R$ ${parseFloat(p.price).toFixed(2)}</p>
              <a href="/produtos/${p.id}" class="btn-detalhes">Ver Detalhes</a>
              ${isAdmin ? `
              <div class="product-actions">
                <button class="btn-edit" onclick="openEditModal(${p.id})">‚úèÔ∏è Editar</button>
                <button class="btn-delete" onclick="deleteProduct(${p.id})">üóëÔ∏è Deletar</button>
              </div>
              ` : ''}
            </div>
          </div>
        `).join('');
      }

      function openEditModal(id) {
        const product = allProducts.find(p => p.id === id);
        if (!product) return;

        editingProductId = id;
          document.getElementById('edit-prod-name').value = product.name;
          document.getElementById('edit-prod-desc').value = product.description || '';
          document.getElementById('edit-prod-price').value = product.price;
          document.getElementById('edit-prod-image').value = product.image;
          // Ajustar t√≠tulo do modal para editar
          const modalTitle = document.querySelector('#edit-product-modal h2');
          if (modalTitle) modalTitle.textContent = 'Editar Produto';
          document.getElementById('edit-product-modal').classList.add('show');
      }


        function openNewProductModal() {
          editingProductId = null;
          document.getElementById('edit-prod-name').value = '';
          document.getElementById('edit-prod-desc').value = '';
          document.getElementById('edit-prod-price').value = '';
          document.getElementById('edit-prod-image').value = '';
          const modalTitle = document.querySelector('#edit-product-modal h2');
          if (modalTitle) modalTitle.textContent = 'Novo Produto';
          document.getElementById('edit-product-modal').classList.add('show');
        }
      function closeEditModal() {
        document.getElementById('edit-product-modal').classList.remove('show');
        editingProductId = null;
      }

      async function saveProductEdit(e) {
        e.preventDefault();
        const supabase = ensureSupabase();

        const data = {
          name: document.getElementById('edit-prod-name').value,
          description: document.getElementById('edit-prod-desc').value,
          price: parseFloat(document.getElementById('edit-prod-price').value),
          image: document.getElementById('edit-prod-image').value
        };

        try {
          if (editingProductId) {
            const { error } = await supabase
              .from('products')
              .update(data)
              .eq('id', editingProductId);
            if (error) throw error;
            showNotification('Produto atualizado com sucesso!', 'success');
          } else {
            const { error } = await supabase
              .from('products')
              .insert([data]);
            if (error) throw error;
            showNotification('Produto criado com sucesso!', 'success');
          }

          closeEditModal();
          await loadProducts();
        } catch (err) {
          showNotification('Erro ao salvar: ' + (err.message || err), 'error');
        }
      }

      async function deleteProduct(id) {
        const confirmDelete = await showConfirm('Confirma√ß√£o', 'Tem certeza que deseja deletar este produto?');
        if (!confirmDelete) return;
        const supabase = ensureSupabase();
        try {
          const { error } = await supabase
            .from('products')
            .delete()
            .eq('id', id);

          if (error) throw error;

          showNotification('Produto deletado com sucesso!', 'success');
          await loadProducts();
        } catch (err) {
          showNotification('Erro ao deletar: ' + err.message, 'error');
        }
      }

      // Carregar produtos quando a p√°gina for carregada
      document.addEventListener('DOMContentLoaded', loadProducts);

      // Fechar modal ao clicar fora
      document.getElementById('edit-product-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('edit-product-modal')) {
          closeEditModal();
        }
      });
    </script>
</main>